# 페킷 구조

이 분석은 스플래툰 2에서 수행되었습니다.

# 개요

이 글은 nn::pia::common::Packet 클래스에 대해 다룹니다.

# Class Structure


```c
/*
   This file has been generated by IDA.
   It contains local type definitions from
   the type library 'acnh'
*/

#define __int8 char
#define __int16 short
#define __int32 int
#define __int64 long long

/* 804 */
struct __attribute__((aligned(8))) nn::pia::common::Packet::Header::vtable
{
  __int64 nn::pia::lan::LanMessage::refunc_8252ed30;
  __int64 nn::pia::common::Packet::Header::_TILDE_Header;
  __int64 nn::pia::common::Packet::Header::Serialize;
  __int64 nn::pia::common::Packet::Header::Deserialize;
  __int64 nn::pia::common::Packet::Header::GetSerializedSize;
};

/* 806 */
struct __attribute__((aligned(8))) nn::pia::common::Packet::Header
{
  nn::pia::common::Packet::Header::vtable *vtable_;
  int magic_;
  char flag_;
  char padding1[3];
  int destination_variable_id_;
  int source_variable_id_;
  __int16 packet_id_;
  char footer_size_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 aes_gcm_nonce_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 aes_gcm_authentication_tag_;
  __attribute__((packed)) __attribute__((aligned(1))) __int64 unknown1;
  __attribute__((aligned(8))) char packet_[1472];
  int packet_size_;
  __attribute__((aligned(8))) int assign_size_;
  int unknown2;
  char nn::pia::common::StationAddress_[40];
  int unknown3;
};
```

## nn::pia::common::Packet::Header

nn::pia::common::Packet::Header의 구조체로 패킷을 담고 있는 클래스다. 이 클래스에서 패킷을 암복호화와 사이즈 검사 등 패킷과 관련한 메소드들과 데이터가 들어가 있다.

| offset | type | Description |
| --- | --- | --- |
| 0 | offset | vtable |
| 8 | char[4] | magic (0x32AB9864) |
| C | u8 | 0x80: Encryption enabled
0x7F: Version number (9) |
| D | padding | 3 empty bytes |
| 10 | u32 | destination variable id |
| 14 | u32 | source variable id |
| 18 | u16 | packet id |
| 1A | u8 | footer size |
| 1B | u8[8] | AES-GCM nonce |
| 23 | u8[8] | AES-GCM authentication tag (first 8 bytes) |
| 2B | u64 | unknown |
| 33 | padding | 5 empty bytes |
| 38 | u8[0x5C0] | Packet(0:Packet Header, 0x20:Packet Data?) |
| 5F8 | u32 | assign size? |
| 5FC | u32 | unknown |
| 600 | nn::pia::common::StationAddress |  |
| 628 | u32 | unknown |
| 62C | padding | 4 empty bytes |
| 630 | nn::pia::common::StationAddress |  |
| 658 | u8 | unknown |

# VTable 구조체

nn::pia::common::Packet::Header class의 vtable 구조체다.

| offset | function name | description |
| --- | --- | --- |
| 0 | nn::pia::lan::LanMessage::refunc_8252ed30 |  |
| 8 | nn::pia::common::Packet::Header::~Header | destucture |
| 10 | nn::pia::common::Packet::Header::Serialize | Serialize Packet (패킷에 헤더를 삽입함) |
| 18 | nn::pia::common::Packet::Header::Deserialize | Deserialize Packet (Packet 헤더를 파싱함) |
| 20 | nn::pia::common::Packet::Header::GetSerializedSize | Header size(always 0x20) |

# 함수(base 0x80000000)

base 주소가 0x80000000 일 때 nn::pia::common::Packet 관련 함수의 위치와 역할이다.

| address | function name | description |
| --- | --- | --- |
| 0x8253BD00 | nn::pia::common::Packet::PacketData::SerializeHeader | Serialize Packet (Inserts header to a packet) |
| 0x8253BD30 | nn::pia::common::Packet::Header::Serialize | Serialize Packet (Inserts header to a packet) |
| 0x8253BEA0 | nn::pia::common::Packet::PacketData::DeserializeHeader | Deserialize Packet (Parses packet’s header) |
| 0x8253BEB0 | nn::pia::common::Packet::Header::Deserialize | Deserialize Packet (Parses packet’s header) |
| 0x8253BFD0 | nn::pia::common::Packet::PacketData::GetPayload | Get PacketData |
| 0x8253BFF0 | nn::pia::common::Packet::Packet | Consturture |
| 0x8253C0C0 | nn::pia::common::Packet::Reset | Reset Packet |
| 0x8253C150 | nn::pia::common::Packet::~Packet | Distucture |
| 0x8253C190 | nn::pia::common::Packet::IsValid | Is Packet Valid |
| 0x8253C1D0 | sub_8253C1D0 | unknown |
| 0x8253C230 | nn::pia::common::Packet::GetOffset5FC | Get Offset 5FC |
| 0x8253C240 | nn::pia::common::Packet::AssignPayload | Assign Size |
| 0x8253C270 | nn::pia::common::Packet::AssignFooter | Assign footer size |
| 0x8253C2A0 | nn::pia::common::Packet::CopyFrom | Copy from lvalue |
| 0x8253C410 | nn::pia::common::Packet::Encrypt | Encrypt Packet |
| 0x8253C590 | nn::pia::common::Packet::Decrypt | Decrypt Packet |
| 0x8253C700 | nn::pia::common::Packet::Header::~Header | Distructure |
| 0x8253C710 | nn::pia::common::Packet::Header::GetSerializedSize | Header size(always 0x20) |

# 부모 함수

nn::pia::common::ISerializable